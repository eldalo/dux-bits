$('header').backstretch( base_url + 'img/background/bg-body.png');

function getLogin() {
    FB.login(function(response) {
        if (response.authResponse) {
            sessionStorage.token = response.authResponse.accessToken;

            FB.api('/me', function(me) {
                sessionStorage.userID = me.id;

                $.ajax({
                    cache    : false,
                    data     : { fb : me.id, name : me.first_name, lastname : me.last_name, email : me.email },
                    dataType : 'json',
                    type     : 'POST',
                    url      : site_url + 'iniciar-sesion',
                    success  : function(response) {
                        if (response.state)
                            window.location.href = site_url + 'jugar';
                    }
                });
            });
        }
    }, { scope: 'public_profile, email, user_birthday' });
}

function onStateGame(e) {
    if ($(e.currentTarget).data('state')) {
        pause       = true;
        game.paused = true;
        music.pause();

        $(this).addClass('pulse').data('state', false);
        $('#option-game img').attr({ 'src' : base_url + 'images/play-juego.png', 'title': 'Reanudar el Juego' });
    } else {
        pause       = false;
        game.paused = false;
        music.resume();

        $(this).addClass('pulse').data('state', true);
        $('#option-game img').attr({ 'src' : base_url + 'images/pausar-juego.png', 'title': 'Pausear el Juego' });
    }
}

function onShared(e) {
    e.stopPropagation();
    e.preventDefault();

    var url          = '',
        name         = 'Dux Bits'
        caption      = 'Pequeños Bits de sabor',
        description  = 'Con los nuevos Dux Bits mi ritmo no para en estas vacaciones. Juega aquí y participa por un iPod Nano cada semana.',
        image        = 'http://appfeelingco.com/dux-bits/public/images/dux-bits-de-sabor.png',
        uri          = 'http://www.laactituddux.com';
        tw           = 'Con la @ActitudDux y los nuevos Bits, podré ganar un iPod Nano cada semana. Juega aquí http://goo.gl/l1c8bq para que tu ritmo siga.';
        
    if ($(e.currentTarget).data('type') == 'fb') {
        FB.ui({
            method      : 'feed',
            name        : name,
            link        : uri,
            caption     : caption,
            picture     : image,
            description : description
        }, function (response) { });
    }

    if ($(e.currentTarget).data('type') == 'tw')
        onOpen("http://twitter.com/share?url=&text=" + tw + "");
}

function onRegisterPopup() {
    $.lightbox(site_url + 'registrarse', { autoresize : true, height : 550, modal : true, width: 760 });
}

function onFinishedPopup() {
    $.lightbox(site_url + 'siguiente-nivel/' + level, { autoresize : true, height : 550, modal : true, width: 950 });
}

function onGameOver() {
    var height = ($(window).height() - $('#gameover #popup-gameover').height() ) * .5;

    $('#gameover').removeClass('none').css('padding-top', height);
    $('#gameover #popup-gameover').addClass('bounceInUp');
}

function onRegister() {
    if ( $('#frm-register').parsley().validate() ) {
        $('.invalid-form-error-message').html("");
        $('#send').attr('readonly', true);

        $.ajax({
            cache    : false,
            data     : $('#frm-register').serialize(),
            dataType : 'json',
            type     : 'POST',
            url      : site_url + 'nuevo-registro',
            success  : function(response) {
                if (!response.state) {
                    $('.invalid-form-error-message').html( response.message );
                    $('#send').removeAttr('readonly');
                }
                else {
                    $.lightbox().close();
                    onResetLevel(2);
                }
            }
        });
    }
}

function onFinishedLevel() {
    if (level_end == '0') {
        $.ajax({
            cache    : false,
            data     : { id: level },
            dataType : 'json',
            type     : 'POST',
            url      : site_url + 'finalizar-nivel',
            success  : function(response) {
                if (response.state) {
                   if (!response.data.end) {
                        $.lightbox().close();
                        onResetLevel(response.data.level);
                   } else {
                       level = response.data.level;
                       onFinishedPopup();
                   }
                }
            }
        });
    } else {
        if (level == '5') {
            level = '0';
            onFinishedPopup();
        } else  {
            $.lightbox().close();

            level =  parseInt(level) + 1;
            onResetLevel(level.toString());
        }
    }
}

function onResetLevel(value) {
    var panel   = (value != '1') ? 'bg-panel' + value + '.png' : 'bg-panel.png';
        level   = value;
    
    $('#artist').html( level );
    $('#panel-info').css("background-image", "url(" + base_url + "img/background/" + panel + ")");

    init(false);

    game.paused     = false;
    state           = true;

    music.play(value);
    music.volume    = ( life / 100 );
}

$(document).on('ready', function() {
    $('.lightbox').lightbox();

    if ($('#biters').is('section')) {
        $('#participants article').mCustomScrollbar({
            scrollButtons : { enable : true }
        });
    }

    if ($('#home').is('section')) {
        $('#game').on('click', getLogin);
    }

    if ($('#game').is('section')) {
        var panel  = (level != '1') ? 'bg-panel' + level + '.png' : 'bg-panel.png',
            height = ($(window).height() - $('#preload div').height() ) * .5;
        
        window.ParsleyValidator.setLocale('es');

        $('#preload').removeClass('none').css('padding-top', height);
        $('#preload #inst-bounce').addClass('bounce');
        $('#preload #inst-shake').addClass('shake');
        $('#preload #inst-taba').addClass('taba');
        $('#preload #inst-bounceInUp').addClass('bounceInUp');
        $('#preload #percentage').addClass('bounceInUp');
        $('#panel-info').css('background-image', 'url(' + base_url + 'img/background/' + panel + ')');

        $('#option-game').on('click', onStateGame);
        $('#close').on('click', function() {
            window.location.href = site_url + 'cerrar-sesion';
        });
    }

    if ($('#terms').is('section')) {
        $('#terms article').mCustomScrollbar({
            scrollButtons : { enable : true }
        });
    }
});

$(document).on('click', '#fb, #tw', onShared);
$(document).on('click', '#send', onRegister);
$(document).on('click', '#next-level', onFinishedLevel);
$(document).on('click', '#init-game', function() {
    window.location.href = site_url + 'jugar';
});
